__author__ = 'cierpka'
import hashlib

import transaction

from ZODB_Handler import ZODBConnect


def addUser():
    path = "userinput.fs"
    db = ZODBConnect(path)
    dbroot = db.dbroot
    users = dbroot['users']
    new_user = raw_input("Enter a new user here! \n")
    new_dict = {}
    new_pass = ""
    if new_user in users:
        print "%s already exists" % new_user
        selection = raw_input("Do you want to update his password? Type 'pwd'\n"
                              "Otherwise press something to exit\n")

        if selection == 'pwd':
            pwd = raw_input("Type the new password \n")
            new_dict = {new_user: {'password': hashlib.sha512(pwd).hexdigest(), 'data': dict()}}
        else:
            print "Closing script!"
            exit()
    else:
        new_pass = raw_input("Enter a new password here! \n")
        valid_pass = raw_input("Reenter the password! \n")
        if new_pass != valid_pass:
            print "Password was incorrect! Exit"
            exit()

    new_dict = {new_user: {'password': hashlib.sha512(new_pass).hexdigest(), 'data': dict()}}
    users.update(new_dict)
    dbroot['users'] = users
    print dbroot['users']
    transaction.commit()
    db.close()


if __name__ == "__main__":
    addUser()